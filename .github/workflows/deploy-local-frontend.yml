name: Build & deploy frontend locally (test | prod)

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (test|prod). If empty, branch determines environment.'
        required: false
        default: ''
      deploy:
        description: 'If true (manual), run docker compose up after build'
        required: false
        default: 'true'

permissions:
  contents: read

jobs:
  build-and-deploy-local:
    runs-on: [self-hosted]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build (production)
        run: npm run build -- --configuration=production

      - id: vars
        name: Determine environment & targets (cross-platform)
        uses: actions/github-script@v6
        with:
          script: |
            const eventName = process.env.GITHUB_EVENT_NAME;
            const payload = require(process.env.GITHUB_EVENT_PATH || '{}');
            const inputs = (payload && payload.inputs) ? payload.inputs : {};
            let env = '';
            if (eventName === 'workflow_dispatch' && inputs.environment) {
              env = inputs.environment;
            } else {
              const ref = process.env.GITHUB_REF || '';
              const branch = ref.split('/').pop();
              env = (branch === 'master') ? 'prod' : 'test';
            }
            const image = (env === 'prod') ? 'physio-prod-frontend:latest' : 'physio-test-frontend:latest';
            const compose_file = (env === 'prod') ? 'compose.prod.yml' : 'compose.test.yml';
            const project = (env === 'prod') ? 'physio-prod' : 'physio-test';
            core.setOutput('env', env);
            core.setOutput('image', image);
            core.setOutput('compose_file', compose_file);
            core.setOutput('project', project);

      - name: Check for prebuilt dist (cross-platform)
        id: check_dist
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const hasDist = fs.existsSync('dist/index.html');
            core.setOutput('has_dist', hasDist ? 'true' : 'false');

      - name: Build runtime Docker image
        if: steps.check_dist.outputs.has_dist == 'true'
        run: docker build -f Dockerfile.runtime -t ${{ steps.vars.outputs.image }} .

      - name: Build full Docker image
        if: steps.check_dist.outputs.has_dist != 'true'
        run: docker build -t ${{ steps.vars.outputs.image }} .

      - name: Start container with docker compose
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') }}
        run: |
          docker compose -p ${{ steps.vars.outputs.project }} -f ${{ steps.vars.outputs.compose_file }} up -d --no-deps
          sleep 2