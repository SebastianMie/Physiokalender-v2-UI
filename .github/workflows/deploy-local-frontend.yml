name: Build & deploy frontend locally (test | prod)

on:
  push:
    branches: [ test, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (test|prod). If empty, branch determines environment.'
        required: false
        default: ''
      deploy:
        description: 'If true (manual), run docker compose up after build'
        required: false
        default: 'true'

permissions:
  contents: read

jobs:
  build-and-deploy-local:
    runs-on: [self-hosted]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build (production)
        run: npm run build -- --configuration=production

      - id: vars
        name: Determine environment & targets (cross-platform)
        uses: actions/github-script@v6
        with:
          script: |
            const eventName = process.env.GITHUB_EVENT_NAME;
            const payload = require(process.env.GITHUB_EVENT_PATH || '{}');
            const inputs = (payload && payload.inputs) ? payload.inputs : {};
            let env = '';
            if (eventName === 'workflow_dispatch' && inputs.environment) {
              env = inputs.environment;
            } else {
              const ref = process.env.GITHUB_REF || '';
              const branch = ref.split('/').pop();
              env = (branch === 'master') ? 'prod' : 'test';
            }
            const image = (env === 'prod') ? 'physio-prod-frontend:latest' : 'physio-test-frontend:latest';
            const compose_file = (env === 'prod') ? 'compose.prod.yml' : 'compose.test.yml';
            const health_url = (env === 'prod') ? 'http://127.0.0.1/' : 'http://127.0.0.1:4201/';
            core.setOutput('env', env);
            core.setOutput('image', image);
            core.setOutput('compose_file', compose_file);
            core.setOutput('health_url', health_url);

      - name: Build Docker image (use prebuilt dist when present)
        run: |
          if [ -d dist ] && [ -f dist/index.html ]; then
            echo "Found prebuilt dist/ — building lightweight runtime image"
            docker build -f Dockerfile.runtime -t ${{ steps.vars.outputs.image }} .
          else
            echo "No dist/ found — fallback to full Dockerfile build"
            docker build -t ${{ steps.vars.outputs.image }} .
          fi

      - name: Start container with docker compose
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true') }}
        run: |
          docker compose -f ${{ steps.vars.outputs.compose_file }} up -d --no-deps
          sleep 2

      - name: Healthcheck
        run: |
          curl -f "${{ steps.vars.outputs.health_url }}" || (echo "healthcheck failed" && exit 2)

